input {
  beats {
    port => 5044
    ssl_enabled => true
    ssl_certificate_authorities => ["/usr/share/logstash/config/secrets/ca.crt"]
    ssl_certificate => "/usr/share/logstash/config/secrets/logstash.crt"
    ssl_key => "/usr/share/logstash/config/secrets/logstash.key"
    ssl_client_authentication => "required"
  }
}

filter {

  if [log_id] == "alertmanager"
  {
    if [message] !~ /^\{/ {
      drop { }
    }
    json {
      source => "message"
    }
    if [time] {
      date {
        match => [ "time", "ISO8601" ]
        target => "@timestamp"
        remove_field => ["time"]
      }
    }
  }
  else if [log_id] == "cadvisor"
  {
    grok {
      match => { "message" => "(?<severity>[IWEF])%{MONTHNUM:month}%{MONTHDAY:day} %{TIME:time}\s+%{INT:pid} %{DATA:filename}:%{INT:line}\] %{GREEDYDATA:log_message}" }
    }
    if !("_grokparsefailure" in [tags]) {
      mutate {
        add_field => { "timestamp_str" => "%{month}/%{day} %{time}" }
      }
      date {
        match => [ "timestamp_str", "MM/dd HH:mm:ss.SSSSSS" ]
        target => "@timestamp"
        remove_field => [ "timestamp_str", "month", "day", "time" ]
      }
      mutate {
        gsub => [ "severity", "I", "INFO", "W", "WARNING", "E", "ERROR", "F", "FATAL" ]
      }
    }
  }
  else if [log_id] == "elasticsearch" or [log_id] == "filebeat" or [log_id] == "kibana"
  {
    if [message] !~ /^\{/ {
      drop { }
    }
    json {
      source => "message"
      
    }
  }
  else if [log_id] == "grafana"
  {
    if [message] !~ /^\{/ {
      drop { }
    }
    json {
      source => "message"
      
    }
    if [t] {
      date {
        match => [ "t", "ISO8601" ]
        target => "@timestamp"
        remove_field => ["t"]
      }
    }
  }
  else if [log_id] == "vault-server" or [log_id] =~ /^vault-agent-/
  {
    if [message] !~ /^\{/ {
      drop { }
    }

    json {
      source => "message"
      
    }

  }
  else if [log_id] == "vault-server-audit"
  {
    if [message] !~ /^\{/ {
      drop { }
    }

    json {
      source => "message"
      
    }

    if [time] {
      date {
        match => [ "time", "ISO8601" ]
        target => "@timestamp"
        remove_field => ["time"]
      }
    }
  }
  else if [log_id] == "logstash"
  {
    if [message] !~ /^\{/ {
      drop { }
    }
    json {
      source => "message"
      
    }
    if [timeMillis] {
      date {
        match => [ "timeMillis", "UNIX_MS" ]
        target => "@timestamp"
        remove_field => ["timeMillis"]
      }
    }
  }
  else if [log_id] == "nginx-frontend-access"
  {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
    date {
      match => [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z" ]
      target => "@timestamp"
      remove_field => [ "timestamp" ]
    }
    mutate {
      convert => {
        "bytes" => "integer"
        "response" => "integer"
      }
    }
    
  }
  else if [log_id] == "nginx-frontend-error"
  {
    grok {
        match => { "message" => [
            "(?<timestamp>%{YEAR}/%{MONTHNUM}/%{MONTHDAY} %{TIME}) \[%{LOGLEVEL:severity}\] %{POSINT:pid}#%{NUMBER:tid}: (\*%{NUMBER:connection_id} )?%{GREEDYDATA:err_message}(?:, client: (?<client_ip>%{IP}|%{HOSTNAME}))(?:, server: %{IPORHOST:server})(?:, request: \"%{GREEDYDATA:request}\")?",
            "(?<timestamp>%{YEAR}/%{MONTHNUM}/%{MONTHDAY} %{TIME}) \[%{LOGLEVEL:severity}\] %{POSINT:pid}#%{NUMBER:tid}: %{GREEDYDATA:err_message}"
        ] }
    }
    date {
      match => [ "timestamp", "yyyy/MM/dd HH:mm:ss" ]
      target => "@timestamp"
      remove_field => [ "timestamp" ]
    }
    
  }
  else if [log_id] == "node-exporter"
  {
    if [message] !~ /^\{/ {
      drop { }
    }
    json {
      source => "message"
      
    }
    if [time] {
      date {
        match => [ "time", "ISO8601" ]
        target => "@timestamp"
        remove_field => ["time"]
      }
    }
  }
  else if [log_id] == "nodejs-backend"
  {
    if [message] !~ /^\{/ {
      drop { }
    }
    json {
      source => "message"
      
    }
    if [req][url] == "/metrics" {
      drop { }
    }
    if [time] {
      date {
        match => [ "time", "ISO8601" ]
        target => "@timestamp"
        remove_field => ["time"]
      }
    }
  }
  else if [log_id] == "prometheus"
  {
    if [message] !~ /^\{/ {
      drop { }
    }
    json {
      source => "message"
      
    }
    if [time] {
      date {
        match => [ "time", "ISO8601" ]
        target => "@timestamp"
        remove_field => ["time"]
      }
    }
  }
  mutate {
      # Supprime les champs système inutiles ajoutés par Logstash et Filebeat
      remove_field => [ 
        "event", 
        "host", 
        "agent", 
        "ecs", 
        "log", 
        "input", 
        "version", 
        "@version",
        "message",
        "tags" # Optionnel : vire les tags si tu ne t'en sers pas
      ]
    }
  # remove_field => ["message"]
  if "_jsonparsefailure" in [tags] {
    mutate { add_tag => ["error_logs_malformed"] }
  }

}

# output {
#    stdout {}
# }

# output {
#   stdout { 
#     codec => rubydebug 
#   }
# }

# output {
#   file {
#     path => "/usr/share/logstash/tmp_logs/logstash_debug.log"
#     codec => line { format => "Custom Debug: %{message} - Extraits: %{log_id} - %{client_ip}" }
#   }
# }

output {
  elasticsearch {
    hosts => ["https://elasticsearch:9200"]
    index => "ls-%{[log_id]}-%{+YYYY.MM.dd}"
    user => "${LOGSTASH_USER}"
    password => "${LOGSTASH_PASSWORD}"
    ssl_enabled => true
    ssl_certificate_authorities => ["/usr/share/logstash/config/secrets/ca.crt"]
    ssl_certificate => "/usr/share/logstash/config/secrets/logstash.crt"
    ssl_key => "/usr/share/logstash/config/secrets/logstash.key"
  }
}
